var UserPasswordResetController=function(){return{config:{reset_popup_container:$('#user-reset-pass-general'),reset_popup_success_container:$('#reset-pass-success'),encrypted_user_info:null,redirect_url:'',recovery_type:''},init:function(){this.get_config_from_url();if($(".header_agencies").length){console.log("Agency page detected, skipping password reset controller due to conflict with agency"+" reset password form");return;}
if(this.config.encrypted_user_info){this.config.reset_popup_container=$('#user-reset-pass-general');this.show_reset_password_popup();this.bind_listeners();}},bind_listeners:function(){let actual_controller=this;this.config.reset_popup_container.find(".btn-send-form").click(function(){if(actual_controller.config.recovery_type&&actual_controller.config.recovery_type==='complaint'){actual_controller.send_password_reset_complaint_seeker();}else{actual_controller.send_password_reset();}});},send_password_reset:function(){if(!this.is_valid_params()){return;}
let new_password=this.config.reset_popup_container.find("#reset-new-password").val();let post_dict={'action':'password_reset','new_password':new_password,'encrypted_info':this.config.encrypted_user_info};$.post('/users/',post_dict,function(e){UserPasswordResetController.hide_reset_password_popup();UserPasswordResetController.config.reset_popup_success_container.show();if(UserPasswordResetController.config.redirect_url){setTimeout(function(){window.location.href=UserPasswordResetController.config.redirect_url;},3000);}
setTimeout(function(){UserPasswordResetController.config.reset_popup_success_container.hide();},3000);});},send_password_reset_complaint_seeker:function(){if(!this.is_valid_params()){return;}
let new_password=this.config.reset_popup_container.find("#reset-new-password").val();let post_dict={'password':new_password,'encrypted_info':this.config.encrypted_user_info};$.ajax({url:'https://complaints-seeker.ew.r.appspot.com/api/user/change-password',type:'PUT',data:JSON.stringify(post_dict),contentType:"application/json",success:function(data){UserPasswordResetController.hide_reset_password_popup();UserPasswordResetController.config.reset_popup_success_container.show();if(UserPasswordResetController.config.redirect_url){setTimeout(function(){window.location.href=UserPasswordResetController.config.redirect_url;},3000);}
setTimeout(function(){UserPasswordResetController.config.reset_popup_success_container.hide();},3000);}});},is_valid_params:function(){let is_valid=true;let main_password=this.config.reset_popup_container.find("#reset-new-password"),repeat_password=this.config.reset_popup_container.find("#reset-repeat-password");let main_password_val=main_password.val(),repeated_password_val=main_password.val();let error_class='error';if(main_password_val!==repeated_password_val){main_password.addClass(error_class);repeat_password.addClass(error_class);is_valid=false;}else{main_password.removeClass(error_class);repeat_password.removeClass(error_class);}
return is_valid;},get_config_from_url:function(){let url_params=this.get_url_params();if(url_params['action']){if(url_params['key']){this.config.encrypted_user_info=url_params['key'];}}
if(url_params['recovery_type']&&url_params['recovery_type']==='complaint'){this.config.recovery_type='complaint';}},show_reset_password_popup:function(){this.config.reset_popup_container.fadeIn();let actual_controller=this;let close_popup_btn=$('#user-reset-pass-general .close-popup');$("body").addClass('reset-password-popup-open');close_popup_btn.click(function(){actual_controller.hide_reset_password_popup();});},hide_reset_password_popup:function(){this.config.reset_popup_container.fadeOut();$("body").removeClass('reset-password-popup-open');},get_url_params:function(){var params={},query=window.location.search.slice(1),vars=query.split('&');for(var i=0;i<vars.length;i++){var pair=vars[i].split('=');params[pair[0]]=decodeURIComponent(pair[1]);}
return params;},};}();